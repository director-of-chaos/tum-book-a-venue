{% extends "base.html" %}

{% block title %}Book a Venue{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-7">
            <!-- Progress Indicator -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
                                 style="width: 40px; height: 40px;">
                                <i class="fas fa-calendar-plus text-white"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0 fw-bold">Step 1 of 2</h6>
                            <small class="text-muted">Fill in your booking details</small>
                        </div>
                        <div class="flex-shrink-0">
                            <div class="progress" style="width: 100px; height: 8px;">
                                <div class="progress-bar bg-primary" role="progressbar" style="width: 50%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Booking Form -->
            <div class="card border-0 shadow">
                <div class="card-header text-center py-4">
                    <h3 class="mb-1 fw-bold">
                        <i class="fas fa-calendar-plus me-2 text-primary"></i>Book Your Venue
                    </h3>
                    <p class="text-muted mb-0">Fill in the details below to submit your booking request</p>
                </div>
                
                <div class="card-body p-4 p-md-5">
                    <form method="POST" id="bookingForm" novalidate>
                        {{ form.hidden_tag() }}
                        
                        <!-- Personal Information Section -->
                        <div class="form-section mb-5">
                            <h5 class="fw-bold mb-4 text-primary">
                                <i class="fas fa-user me-2"></i>Personal Information
                            </h5>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        {{ form.user_name(class="form-control", placeholder="Your full name") }}
                                        {{ form.user_name.label(class="form-label") }}
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        {{ form.user_email(class="form-control", placeholder="your.email@example.com") }}
                                        {{ form.user_email.label(class="form-label") }}
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Event Information Section -->
                        <div class="form-section mb-5">
                            <h5 class="fw-bold mb-4 text-primary">
                                <i class="fas fa-calendar-alt me-2"></i>Event Information
                            </h5>
                            
                            <div class="mb-4">
                                <div class="form-floating">
                                    {{ form.event_title(class="form-control", placeholder="Enter your event title") }}
                                    {{ form.event_title.label(class="form-label") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>

                            <div class="mb-4">
                                {{ form.event_description.label(class="form-label fw-semibold") }}
                                {{ form.event_description(class="form-control", rows="4", placeholder="Describe your event, special requirements, or additional information...") }}
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Optional: Provide details about your event to help us serve you better
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-4">
                                    {{ form.event_date.label(class="form-label fw-semibold") }}
                                    {{ form.event_date(class="form-control") }}
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-floating">
                                        {{ form.start_time(class="form-control", placeholder="Start time") }}
                                        {{ form.start_time.label(class="form-label") }}
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-floating">
                                        {{ form.end_time(class="form-control", placeholder="End time") }}
                                        {{ form.end_time.label(class="form-label") }}
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Venue Selection Section -->
                        <div class="form-section mb-5">
                            <h5 class="fw-bold mb-4 text-primary">
                                <i class="fas fa-building me-2"></i>Venue Selection
                            </h5>
                            
                            <div class="mb-4">
                                {{ form.venue_id.label(class="form-label fw-semibold") }}
                                {{ form.venue_id(class="form-select form-select-lg") }}
                                <div class="form-text">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    Can't find the perfect venue? <a href="{{ url_for('main.view_venues') }}" class="text-decoration-none">Browse all venues</a>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <!-- Selected Venue Preview -->
                            <div id="venuePreview" class="card bg-light border-0 d-none">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-building fa-2x text-primary"></i>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <h6 class="mb-1 fw-bold" id="selectedVenueName"></h6>
                                            <small class="text-muted" id="selectedVenueDetails"></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Terms and Conditions -->
                        <div class="form-section mb-4">
                            <div class="card bg-light border-0">
                                <div class="card-body p-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                                        <label class="form-check-label" for="agreeTerms">
                                            I agree to the <a href="#" class="text-decoration-none">Terms and Conditions</a> 
                                            and understand that this is a booking request subject to approval.
                                        </label>
                                        <div class="invalid-feedback">You must agree to the terms and conditions</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-3">
                            <button type="submit" class="btn btn-success btn-lg py-3" id="submitBtn">
                                <i class="fas fa-paper-plane me-2"></i>
                                Submit Booking Request
                            </button>
                            
                            <div class="text-center">
                                <small class="text-muted">
                                    <i class="fas fa-shield-alt me-1"></i>
                                    Your information is secure and will only be used for booking purposes
                                </small>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Section -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-body p-4 text-center">
                    <h6 class="fw-bold mb-3">Need Help?</h6>
                    <p class="text-muted mb-3">
                        Our team is here to assist you with your booking. 
                        Contact us if you have any questions or special requirements.
                    </p>
                    <div class="d-flex flex-column flex-sm-row gap-2 justify-content-center">
                        <a href="tel:+1234567890" class="btn btn-outline-primary">
                            <i class="fas fa-phone me-2"></i>Call Us
                        </a>
                        <a href="mailto:support@venuebooking.com" class="btn btn-outline-primary">
                            <i class="fas fa-envelope me-2"></i>Email Support
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        position: relative;
    }

    .form-section::before {
        content: '';
        position: absolute;
        left: -2rem;
        top: 0;
        bottom: 0;
        width: 3px;
        background: var(--primary-gradient);
        border-radius: 3px;
    }

    .form-floating > .form-control:focus ~ label,
    .form-floating > .form-control:not(:placeholder-shown) ~ label {
        color: var(--bs-primary);
    }

    .form-floating > .form-control:focus {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .form-select:focus {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .form-check-input:checked {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
    }

    .form-check-input:focus {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    #venuePreview {
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
        .form-section::before {
            left: -1rem;
        }
        
        .card-body {
            padding: 1.5rem 1rem;
        }
        
        .btn-lg {
            padding: 1rem 2rem;
        }
    }

    /* Loading state for submit button */
    .btn-loading {
        position: relative;
        pointer-events: none;
    }

    .btn-loading::after {
        content: '';
        position: absolute;
        width: 1rem;
        height: 1rem;
        margin: auto;
        border: 2px solid transparent;
        border-top-color: #ffffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('bookingForm');
        const submitBtn = document.getElementById('submitBtn');
        const venueSelect = document.getElementById('venue_id');
        const venuePreview = document.getElementById('venuePreview');
        const eventDateInput = document.getElementById('event_date');
        const startTimeInput = document.getElementById('start_time');
        const endTimeInput = document.getElementById('end_time');

        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        eventDateInput.setAttribute('min', today);

        // Venue selection preview
        venueSelect.addEventListener('change', function() {
            if (this.value) {
                // Show venue preview (in real implementation, fetch venue details)
                const selectedOption = this.options[this.selectedIndex];
                document.getElementById('selectedVenueName').textContent = selectedOption.text;
                document.getElementById('selectedVenueDetails').textContent = 'Click to view full details';
                venuePreview.classList.remove('d-none');
            } else {
                venuePreview.classList.add('d-none');
            }
        });

        // Time validation
        startTimeInput.addEventListener('change', validateTimes);
        endTimeInput.addEventListener('change', validateTimes);

        function validateTimes() {
            if (startTimeInput.value && endTimeInput.value) {
                const startTime = new Date(`2000-01-01T${startTimeInput.value}`);
                const endTime = new Date(`2000-01-01T${endTimeInput.value}`);
                
                if (endTime <= startTime) {
                    endTimeInput.setCustomValidity('End time must be after start time');
                    endTimeInput.classList.add('is-invalid');
                } else {
                    endTimeInput.setCustomValidity('');
                    endTimeInput.classList.remove('is-invalid');
                }
            }
        }

        // Form submission with validation
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Custom validation
            let isValid = true;
            const requiredFields = form.querySelectorAll('[required]');
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            // Email validation
            const emailField = document.getElementById('user_email');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailField.value && !emailRegex.test(emailField.value)) {
                emailField.classList.add('is-invalid');
                emailField.nextElementSibling.textContent = 'Please enter a valid email address';
                isValid = false;
            }

            if (isValid) {
                // Show loading state
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
                submitBtn.classList.add('btn-loading');
                submitBtn.disabled = true;
                
                // Update progress
                document.querySelector('.progress-bar').style.width = '100%';
                document.querySelector('.progress-bar').classList.add('bg-success');
                
                // Submit form (remove preventDefault in production)
                setTimeout(() => {
                    form.submit();
                }, 1000);
            } else {
                // Scroll to first error
                const firstError = form.querySelector('.is-invalid');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
            }
        });

        // Real-time validation
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('blur', function() {
                if (this.hasAttribute('required') && !this.value.trim()) {
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                }
            });
        });
    });
</script>
{% endblock %}