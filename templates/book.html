{% extends "base.html" %}

{% block title %}EventSpaces - Book Your Venue{% endblock %}

{% block content %}
<div class="bg-slate-50">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Form Header and Progress -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold tracking-tight text-slate-900 sm:text-4xl">Book Your Venue</h1>
        </div>

        <!-- Main Booking Form -->
        <div class="mt-12 bg-white p-6 sm:p-8 rounded-2xl shadow-lg" x-data='{
                step: 1,
                startTime: "{{ form.start_time.data or '' }}",
                endTime: "{{ form.end_time.data or '' }}",
                bookedSlots: {{ booked_slots_json | safe }},
                allTimes: [
                    { value: '09:00', label: '9:00 AM' }, { value: '09:30', label: '9:30 AM' },
                    { value: '10:00', label: '10:00 AM' }, { value: '10:30', label: '10:30 AM' },
                    { value: '11:00', label: '11:00 AM' }, { value: '11:30', label: '11:30 AM' },
                    { value: '12:00', label: '12:00 PM' }, { value: '12:30', label: '12:30 PM' },
                    { value: '13:00', label: '1:00 PM' }, { value: '13:30', label: '1:30 PM' },
                    { value: '14:00', label: '2:00 PM' }, { value: '14:30', label: '2:30 PM' },
                    { value: '15:00', label: '3:00 PM' }, { value: '15:30', label: '3:30 PM' },
                    { value: '16:00', label: '4:00 PM' }, { value: '16:30', label: '4:30 PM' },
                    { value: '17:00', label: '5:00 PM' }, { value: '17:30', label: '5:30 PM' },
                    { value: '18:00', label: '6:00 PM' }, { value: '18:30', label: '6:30 PM' },
                    { value: '19:00', label: '7:00 PM' }, { value: '19:30', label: '7:30 PM' },
                    { value: '20:00', label: '8:00 PM' }, { value: '20:30', label: '8:30 PM' },
                    { value: '21:00', label: '9:00 PM' }
                ],
                isSlotBooked(time) {
                    return this.bookedSlots.some(slot => time >= slot.start && time < slot.end);
                },
                get availableEndTimes() {
                    const startIndex = this.allTimes.findIndex(t => t.value === this.startTime);
                    if (startIndex === -1) return [];
                    return this.allTimes.slice(startIndex + 1);
                }
             }''>

            <form method="POST" id="bookingForm" class="space-y-8" novalidate>
                {{ form.hidden_tag() }}

                <!-- Step 1: Personal Information (Unchanged) -->
                <div x-show="step === 1" x-transition>
                    <h2 class="text-xl font-semibold text-slate-900 border-b border-slate-200 pb-3 mb-6">Step 1: Your
                        Information</h2>
                    <div class="grid grid-cols-1 gap-y-6">
                        <div>
                            <label for="{{ form.user_name.id }}" class="block text-sm font-medium text-slate-700">Full
                                Name <span class="text-red-500">*</span></label>
                            {{ form.user_name(class="mt-1 block w-full border-slate-300 rounded-md shadow-sm
                            focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm py-3 px-4", placeholder="Jane Doe")
                            }}
                        </div>
                        <div>
                            <label for="{{ form.user_email.id }}" class="block text-sm font-medium text-slate-700">Email
                                Address <span class="text-red-500">*</span></label>
                            {{ form.user_email(class="mt-1 block w-full border-slate-300 rounded-md shadow-sm
                            focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm py-3 px-4",
                            placeholder="you@example.com") }}
                        </div>
                    </div>
                    <div class="pt-8 flex justify-end">
                        <button @click.prevent="step = 2" type="button"
                            class="ml-3 inline-flex justify-center items-center py-3 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Next:
                            Event Details</button>
                    </div>
                </div>

                <!-- Step 2: Event Details -->
                <div x-show="step === 2" x-transition style="display: none;">
                    <h2 class="text-xl font-semibold text-slate-900 border-b border-slate-200 pb-3 mb-6">Step 2: Event
                        Details</h2>
                    <div class="grid grid-cols-1 gap-y-6 sm:grid-cols-6 sm:gap-x-6">

                        <!-- Venue (Unchanged) -->
                        <div class="sm:col-span-6">
                            <label for="{{ form.venue_id.id }}" class="block text-sm font-medium text-slate-700">Venue
                                <span class="text-red-500">*</span></label>
                            {% if preselected_venue %}
                            <div
                                class="mt-1 block w-full bg-indigo-50 border-2 border-indigo-200 rounded-md shadow-sm sm:text-sm py-4 px-4">
                                <p class="font-semibold text-indigo-900">{{ preselected_venue.name }}</p>
                            </div>
                            {{ form.venue_id(style="display: none;") }}
                            {% else %}
                            {{ form.venue_id(class="mt-1 block w-full border-slate-300 rounded-md shadow-sm
                            focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm py-3 px-4") }}
                            {% endif %}
                        </div>

                        <!-- Event Title (Unchanged) -->
                        <div class="sm:col-span-6">
                            <label for="{{ form.event_title.id }}"
                                class="block text-sm font-medium text-slate-700">Event Title <span
                                    class="text-red-500">*</span></label>
                            {{ form.event_title(class="mt-1 block w-full border-slate-300 rounded-md shadow-sm
                            focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm py-3 px-4", placeholder="e.g.,
                            Annual Company Gala") }}
                        </div>

                        <!-- Event Date (Unchanged) -->
                        <div class="sm:col-span-2">
                            <label for="{{ form.event_date.id }}" class="block text-sm font-medium text-slate-700">Event
                                Date <span class="text-red-500">*</span></label>
                            {{ form.event_date(class="mt-1 block w-full border-slate-300 rounded-md shadow-sm
                            focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm py-3 px-4", id="event_date_input")
                            }}
                        </div>

                        <!-- <<< FIX: DYNAMIC START TIME >>> -->
                        <div class="sm:col-span-2">
                            <label for="{{ form.start_time.id }}" class="block text-sm font-medium text-slate-700">Start
                                Time <span class="text-red-500">*</span></label>
                            <select name="{{ form.start_time.name }}" id="{{ form.start_time.id }}" x-model="startTime"
                                class="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm py-3 px-4">
                                <template x-for="time in allTimes.slice(0, -1)" :key="time.value">
                                    <option :value="time.value" :disabled="isSlotBooked(time.value)"
                                        x-text="time.label + (isSlotBooked(time.value) ? ' (Booked)' : '')"></option>
                                </template>
                            </select>
                        </div>

                        <!-- <<< FIX: DYNAMIC END TIME >>> -->
                        <div class="sm:col-span-2">
                            <label for="{{ form.end_time.id }}" class="block text-sm font-medium text-slate-700">End
                                Time <span class="text-red-500">*</span></label>
                            <select name="{{ form.end_time.name }}" id="{{ form.end_time.id }}" x-model="endTime"
                                class="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm py-3 px-4">
                                <template x-for="time in availableEndTimes" :key="time.value">
                                    <option :value="time.value" :disabled="isSlotBooked(time.value)"
                                        x-text="time.label + (isSlotBooked(time.value) ? ' (Booked)' : '')"></option>
                                </template>
                            </select>
                        </div>

                        <!-- Description & Navigation (Unchanged) -->
                        <div class="sm:col-span-6">
                            <label for="{{ form.event_description.id }}"
                                class="block text-sm font-medium text-slate-700">Additional Information</label>
                            {{ form.event_description(class="mt-1 block w-full border-slate-300 rounded-md shadow-sm
                            focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm py-3 px-4", rows="4") }}
                        </div>
                    </div>
                    <div class="pt-8 flex justify-between">
                        <button @click.prevent="step = 1" type="button"
                            class="bg-white py-3 px-6 border border-slate-300 rounded-md shadow-sm text-base font-medium text-slate-700 hover:bg-slate-50">Back</button>
                        <button type="submit"
                            class="inline-flex justify-center items-center py-3 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Submit
                            Request</button>
                    </div>
                </div>
            </form>
        </div>
        <p class="text-center text-xs text-slate-500 mt-4">Note: Changing the date will reload the page to fetch the
            latest availability.</p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dateInput = document.getElementById('event_date_input');
        if (dateInput) {
            const today = new Date().toISOString().split('T')[0];
            dateInput.setAttribute('min', today);

            // Reload the page with the new date query parameter to fetch correct availability
            dateInput.addEventListener('change', function () {
                const url = new URL(window.location.href);
                url.searchParams.set('date', this.value);
                window.location.href = url.toString();
            });
        }
    });
</script>
{% endblock %}